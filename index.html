#!/bin/bash

red='\033[0;31m'
green='\033[0;32m'
yellow='\033[0;33m'
plain='\033[0m'

# Check if user is root
[ $(id -u) != "0" ] && { echo -e "${red}Error:${plain} Error: You must be root to run this script"; exit 1; }

if [ ! -n "$1" ] ;then
  echo -e "${red}Error:${plain} You must specify a hostname."
  exit
fi

#Hostname
echo -e "${green}Info:${plain} Setting up hostname $1..."
hostname "ecs-$1.cn2.network"
echo -e "ecs-$1.cn2.network" > /etc/hostname
sed -i "s/$HOSTNAME/ecs-$1.cn2.network/g" /etc/hosts
echo -e "${green}Info:${plain} Hostname OK!"

#BBR
echo -e "${green}Info:${plain} Setting up BBR..."
param=$(sysctl net.ipv4.tcp_congestion_control | awk '{print $3}')
if [[ x"${param}" == x"bbr" ]]; then
    echo -e "${green}Info:${plain} TCP BBR has already been installed. nothing to do..."
else
    sed -i '/net.core.default_qdisc/d' /etc/sysctl.conf
    sed -i '/net.ipv4.tcp_congestion_control/d' /etc/sysctl.conf
    echo "net.core.default_qdisc = fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control = bbr" >> /etc/sysctl.conf
    sysctl -p >/dev/null 2>&1
fi

echo -e "${green}Info:${plain} BBR OK!"

#SWAP
echo -e "${green}Info:${plain} Setting up SWAP..."
if [ -e /swap ]
then
  echo -e "${green}Info:${plain} SWAP has already been installed. nothing to do..."
else
  dd if=/dev/zero of=/swap bs=1M count=1024
  chmod 0600 /swap
  mkswap /swap
  swapon /swap
  echo '/swap none swap defaults 0 0' >> /etc/fstab
fi
echo -e "${green}Info:${plain} SWAP OK!"

#LOGIN MOTD
echo -e "${green}Info:${plain} Setting up MOTD..."
motdpath='/etc/update-motd.d'
cat > $motdpath/00-header <<EOL
#!/bin/sh
printf  "Welcome to $1 Server!\n"
curl "https://api.lwl12.com/hitokoto/main/get" -m 2
printf "\n---------------------"
EOL
rm $motdpath/10-help-text $motdpath/50-motd-news $motdpath/80-esm $motdpath/95-hwe-eol $motdpath/80-livepatch
echo -e "${green}Info:${plain} MOTD OK!"

#Docker
echo -e "${green}Info:${plain} Setting up Docker..."
sudo apt-get remove docker docker-engine docker.io
sudo apt-get update
sudo apt-get install -y \
     apt-transport-https \
     ca-certificates \
     curl \
     software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo apt-key fingerprint 0EBFCD88
sudo add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"
sudo apt-get update
sudo apt-get install docker-ce -y
sudo docker version
#echo '{ "registry-mirrors": ["https://registry.docker-cn.com"] }' > /etc/docker/daemon.json
sudo docker run hello-world
echo -e "${yellow}WARNING:${plain} Don't forget to set newest docker compose version!"
sudo curl -L "https://github.com/docker/compose/releases/download/1.22.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
docker-compose --version
echo -e "${green}Info:${plain} Docker OK!"

#LFS
echo -e "${green}Info:${plain} Setting up LFS..."
apt-get install git -y
cd /opt
git clone https://github.com/lwl12/LFS-Docker-Compose.git
echo -e "TZ=Asia/Shanghai\nHostname=$1" > /opt/LFS-Docker-Compose/.env
echo -e "${green}Info:${plain} LFS OK!"

#logrotate
echo -e "${green}Info:${plain} Setting up logrotate..."
cat > /etc/logrotate_nginx.conf <<EOL
/data/wwwlogs/*/nginx.log {
    daily
    rotate 365
    compress
    delaycompress
    dateyesterday
    dateext
    create
    missingok
    notifempty
    sharedscripts
    postrotate
        docker inspect -f '{{ .State.Pid }}' nginx | xargs kill -USR1
    endscript
}
EOL
crontab -l | { cat; echo "0 0 * * * /usr/sbin/logrotate --force /etc/logrotate_nginx.conf"; } | crontab -
echo -e "${green}Info:${plain} logrotate OK!"

#User
echo -e "${green}Info:${plain} Setting up user..."
useradd lwl12
chage -d 0 lwl12
passwd -d lwl12
mkdir /home/lwl12/.ssh/ -p
echo "ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAGFJYtyrc/bvohe5f0mTSSwlDoZj+i5/v9NhBz7ILGlEh2pe/DtmeSeiFFPewLBLFc40nG/P+OsI/K8y+5ePEUHJgBWWLfI80CVUwz9FmnChEFdi2lJlFVpgMP2R4muNhvL8HCFRKLMZW215YpyqIA5J+Wi4+Xr5ey/K5V4Cmj+sTEXPQ== lwl_ecdsa_521" > /home/lwl12/.ssh/authorized_keys
chown lwl12:lwl12 /home/lwl12 -R
chmod 644 /home/lwl12/.ssh/authorized_keys
echo "lwl12  ALL=(ALL:ALL) ALL" >> /etc/sudoers
echo -e "${green}Info:${plain} User OK!"

#SSH
echo -e "${green}Info:${plain} Setting up SSH..."
if [ -z "`grep ^Port /etc/ssh/sshd_config`" ]; then
    sed -i "s@^#Port.*@&\nPort 36015@" /etc/ssh/sshd_config
elif [ -n "`grep ^Port /etc/ssh/sshd_config`" ]; then
    sed -i "s@^Port.*@Port 36015@" /etc/ssh/sshd_config
fi

sed -i "s@^#PasswordAuthentication.*@&\nPasswordAuthentication no@" /etc/ssh/sshd_config
systemctl restart ssh
echo -e "${green}Info:${plain} SSH OK!"

#ZSH
echo -e "${green}Info:${plain} Setting up ZSH..."
apt-get install zsh -y
sh -c "$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
echo -e "${green}Info:${plain} ZSH OK!"


echo -e "${green}Info:${plain} INIT OK!\nDON'T FORGET DEL DEFAULT USER!"
exit 0;
